<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
.r1 {color: #005f00; text-decoration-color: #005f00}
.r2 {font-weight: bold}
.r3 {color: #000080; text-decoration-color: #000080; font-weight: bold}
.r4 {color: #005f00; text-decoration-color: #005f00; font-weight: bold}
.r5 {color: #87af00; text-decoration-color: #87af00; font-weight: bold}
.r6 {color: #7f7f7f; text-decoration-color: #7f7f7f; font-weight: bold}
.r7 {color: #000080; text-decoration-color: #000080; font-weight: bold; font-style: italic}
.r8 {color: #005f00; text-decoration-color: #005f00; font-weight: bold; font-style: italic}
.r9 {color: #87af00; text-decoration-color: #87af00; font-weight: bold; font-style: italic}
.r10 {color: #7f7f7f; text-decoration-color: #7f7f7f}
.r11 {color: #000080; text-decoration-color: #000080}
.r12 {color: #87af00; text-decoration-color: #87af00}
.r13 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8; font-weight: bold}
.r14 {color: #000000; text-decoration-color: #000000; background-color: #f8f8f8}
.r15 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8; font-weight: bold}
.r16 {background-color: #f8f8f8}
.r17 {color: #666666; text-decoration-color: #666666; background-color: #f8f8f8}
.r18 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8}
.r19 {color: #3d7b7b; text-decoration-color: #3d7b7b; background-color: #f8f8f8; font-style: italic}
.r20 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8}
.r21 {color: #bbbbbb; text-decoration-color: #bbbbbb; background-color: #f8f8f8}
.r22 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8; font-style: italic}
.r23 {color: #aa22ff; text-decoration-color: #aa22ff; background-color: #f8f8f8; font-weight: bold}
.r24 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8}
.r25 {color: #a45a77; text-decoration-color: #a45a77; background-color: #f8f8f8; font-weight: bold}
.r26 {color: #aa22ff; text-decoration-color: #aa22ff; background-color: #f8f8f8}
.r27 {font-weight: bold; font-style: italic}
.r28 {font-style: italic}
.r29 {color: #000080; text-decoration-color: #000080; text-decoration: underline}
body {
    color: #000000;
    background-color: #ffffff;
}
</style>
</head>
<body>
    <pre style="font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><code>                          Memory usage: <span class="r1">▂▄▅▅██▄▄▄▃▃▂▂▁▁▁▁▁▁▁▄▁▄▁▁▁▄</span> (max: 124.412 MB, growth rate:   0%)                           
        /home/ec2-user/opt/timesync/tony/2a_cmdline/ts_process_group.py: % of time =  96.24% (3m:57.587s) out of 3m:4.534s.        
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                          
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r4">Memory</span><span class="r2">  </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r4">–––––––––––</span><span class="r2">    </span>│<span class="r5">Copy</span><span class="r2">   </span>│<span class="r2">                                                         </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">system</span><span class="r2"> </span>│<span class="r8">Python</span><span class="r2">  </span>│<span class="r8">peak</span><span class="r2">   </span>│<span class="r8">timeline</span><span class="r4">/%</span><span class="r2">     </span>│<span class="r9">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/ec2-user/opt/timesync/tony/2a_cmdline/ts_process_… </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">os</span><span class="r16">                                               </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">numpy</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">np</span><span class="r16">                                      </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">itertools</span><span class="r16">                                        </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">  98%   </span>│<span class="r1">   10M </span>│<span class="r1">▁              </span>│<span class="r12">     1 </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">rasterio</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">rio</span><span class="r16">                                  </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pandas</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">pd</span><span class="r16">                                     </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">  99%   </span>│<span class="r1">   10M </span>│<span class="r1">▁              </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pystac_client</span><span class="r16">                                    </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">fsspec</span><span class="r16">                                           </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1"> 100%   </span>│<span class="r1">   10M </span>│<span class="r1">▁              </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">s3fs</span><span class="r16">                                             </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">copy</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> copy</span><span class="r16">                                   </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">dataclasses</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> dataclass</span><span class="r16">                       </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">typing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> List, Tuple, Optional, Any, Callable,</span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">functools</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> partial, reduce, wraps</span><span class="r16">            </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">fsspec.implementations.local</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> LocalFileSystem</span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">ts_stac_cog</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> StacRecord</span><span class="r16">                      </span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">Affine </span><span class="r17">=</span><span class="r14"> Tuple[</span><span class="r18">float</span><span class="r14">, </span><span class="r18">float</span><span class="r14">, </span><span class="r18">float</span><span class="r14">, </span><span class="r18">float</span><span class="r14">, </span><span class="r18">float</span><span class="r14">, </span><span class="r18">float</span><span class="r14">]</span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r19"># Constants</span><span class="r16">                                             </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">QA_FILL </span><span class="r17">=</span><span class="r14"> </span><span class="r17">0</span><span class="r16">                                             </span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">QA_CLEAR </span><span class="r17">=</span><span class="r14"> </span><span class="r17">6</span><span class="r16">                                            </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">QA_WATER </span><span class="r17">=</span><span class="r14"> </span><span class="r17">7</span><span class="r16">                                            </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">CONCURRENT_STAC_QUERIES </span><span class="r17">=</span><span class="r14"> </span><span class="r17">2</span><span class="r14">  </span><span class="r19"># Prevents workers from con</span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">LANDSAT_ARD_C2_FILL_VALUE </span><span class="r17">=</span><span class="r14"> </span><span class="r17">0</span><span class="r16">                           </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r19"># This AWS stuff could likely be simplified more to come</span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">adjust_for_s3</span><span class="r14">(in_dict, filesystem) </span><span class="r17">-&gt;</span><span class="r14"> </span><span class="r18">dict</span><span class="r14">:</span><span class="r16">         </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Adjust the output file names to use the /vsis3/ file</span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out_dict </span><span class="r17">=</span><span class="r14"> copy(in_dict)</span><span class="r16">                            </span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r18">isinstance</span><span class="r14">(filesystem, s3fs</span><span class="r17">.</span><span class="r14">core</span><span class="r17">.</span><span class="r14">S3FileSystem):</span><span class="r16">  </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> key </span><span class="r23">in</span><span class="r14"> in_dict:</span><span class="r16">                             </span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r13">if</span><span class="r14"> in_dict[key]</span><span class="r17">.</span><span class="r14">endswith(</span><span class="r24">&#x27;.png&#x27;</span><span class="r14">) </span><span class="r23">or</span><span class="r14"> in_dict[</span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                out_dict[key] </span><span class="r17">=</span><span class="r14"> in_dict[key]</span><span class="r17">.</span><span class="r14">replace(</span><span class="r24">&#x27;s3</span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> out_dict</span><span class="r16">                                     </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">output_files</span><span class="r14">(project_dir: </span><span class="r18">str</span><span class="r14">, project_id: </span><span class="r18">str</span><span class="r14">, plot</span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Build the file names for the output files for TimeSy</span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> {</span><span class="r16">                                            </span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;scsv&#x27;</span><span class="r14">: os</span><span class="r17">.</span><span class="r14">path</span><span class="r17">.</span><span class="r14">join(project_dir, </span><span class="r24">f&#x27;prj_</span><span class="r25">{</span><span class="r14">project</span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;tcap&#x27;</span><span class="r14">: os</span><span class="r17">.</span><span class="r14">path</span><span class="r17">.</span><span class="r14">join(project_dir, </span><span class="r24">f&#x27;prj_</span><span class="r25">{</span><span class="r14">project</span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;b743&#x27;</span><span class="r14">: os</span><span class="r17">.</span><span class="r14">path</span><span class="r17">.</span><span class="r14">join(project_dir, </span><span class="r24">f&#x27;prj_</span><span class="r25">{</span><span class="r14">project</span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;b432&#x27;</span><span class="r14">: os</span><span class="r17">.</span><span class="r14">path</span><span class="r17">.</span><span class="r14">join(project_dir, </span><span class="r24">f&#x27;prj_</span><span class="r25">{</span><span class="r14">project</span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r26">@dataclass</span><span class="r14">(frozen</span><span class="r17">=</span><span class="r13">True</span><span class="r14">)</span><span class="r16">                                 </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">class</span><span class="r14"> </span><span class="r15">Bounds</span><span class="r14">:</span><span class="r16">                                           </span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Class to hold spatial coordinate bounds</span><span class="r16">             </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    min_x: </span><span class="r18">float</span><span class="r16">                                        </span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_x: </span><span class="r18">float</span><span class="r16">                                        </span>  
 <span class="r10">   64 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    min_y: </span><span class="r18">float</span><span class="r16">                                        </span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_y: </span><span class="r18">float</span><span class="r16">                                        </span>  
 <span class="r10">   66 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">timesync_band_list</span><span class="r14">() </span><span class="r17">-&gt;</span><span class="r14"> List[</span><span class="r18">str</span><span class="r14">]:</span><span class="r16">                  </span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Get the bands relevant to TimeSync data retrieval</span><span class="r16">   </span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> [</span><span class="r24">&#x27;blue&#x27;</span><span class="r14">, </span><span class="r24">&#x27;green&#x27;</span><span class="r14">, </span><span class="r24">&#x27;red&#x27;</span><span class="r14">, </span><span class="r24">&#x27;nir08&#x27;</span><span class="r14">, </span><span class="r24">&#x27;swir16&#x27;</span><span class="r14">, </span><span class="r24">&#x27;</span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">landsat_optical_band_list</span><span class="r14">() </span><span class="r17">-&gt;</span><span class="r14"> List[</span><span class="r18">str</span><span class="r14">]:</span><span class="r16">           </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Get the optical wavelength Landsat bands</span><span class="r16">            </span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> [</span><span class="r24">&#x27;blue&#x27;</span><span class="r14">, </span><span class="r24">&#x27;green&#x27;</span><span class="r14">, </span><span class="r24">&#x27;red&#x27;</span><span class="r14">, </span><span class="r24">&#x27;nir08&#x27;</span><span class="r14">, </span><span class="r24">&#x27;swir16&#x27;</span><span class="r14">, </span><span class="r24">&#x27;</span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">centered_window</span><span class="r14">(x: </span><span class="r18">float</span><span class="r14">, y: </span><span class="r18">float</span><span class="r14">, width: </span><span class="r18">int</span><span class="r14">, heig</span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Create a window centered on the x, y of a pixel of i</span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Width and height are in pixels</span><span class="r16">                      </span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    row_offset, col_offset </span><span class="r17">=</span><span class="r14"> ds</span><span class="r17">.</span><span class="r14">index(x, y)</span><span class="r16">             </span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> rio</span><span class="r17">.</span><span class="r14">windows</span><span class="r17">.</span><span class="r14">Window(</span><span class="r16">                          </span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        col_offset </span><span class="r17">-</span><span class="r14"> (width </span><span class="r17">//</span><span class="r14"> </span><span class="r17">2</span><span class="r14">),</span><span class="r16">                      </span>  
 <span class="r10">   90 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        row_offset </span><span class="r17">-</span><span class="r14"> (height </span><span class="r17">//</span><span class="r14"> </span><span class="r17">2</span><span class="r14">),</span><span class="r16">                     </span>  
 <span class="r10">   91 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        width,</span><span class="r16">                                          </span>  
 <span class="r10">   92 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        height)</span><span class="r16">                                         </span>  
 <span class="r10">   93 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   94 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   95 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">centered_bounds</span><span class="r14">(x: </span><span class="r18">float</span><span class="r14">, y: </span><span class="r18">float</span><span class="r14">, width: </span><span class="r18">int</span><span class="r14">, heig</span>  
 <span class="r10">   96 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   97 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Create coordinate bounds centered on an x/y coordina</span>  
 <span class="r10">   98 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   99 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> Bounds(</span><span class="r16">                                      </span>  
 <span class="r10">  100 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        min_x</span><span class="r17">=</span><span class="r14">x </span><span class="r17">-</span><span class="r14"> ((width </span><span class="r17">//</span><span class="r14"> </span><span class="r17">2</span><span class="r14">) </span><span class="r17">*</span><span class="r14"> pixel_size),</span><span class="r16">          </span>  
 <span class="r10">  101 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        max_x</span><span class="r17">=</span><span class="r14">x </span><span class="r17">+</span><span class="r14"> ((width </span><span class="r17">//</span><span class="r14"> </span><span class="r17">2</span><span class="r14">) </span><span class="r17">*</span><span class="r14"> pixel_size),</span><span class="r16">          </span>  
 <span class="r10">  102 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        min_y</span><span class="r17">=</span><span class="r14">y </span><span class="r17">-</span><span class="r14"> ((height </span><span class="r17">//</span><span class="r14"> </span><span class="r17">2</span><span class="r14">) </span><span class="r17">*</span><span class="r14"> pixel_size),</span><span class="r16">         </span>  
 <span class="r10">  103 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        max_y</span><span class="r17">=</span><span class="r14">y </span><span class="r17">+</span><span class="r14"> ((height </span><span class="r17">//</span><span class="r14"> </span><span class="r17">2</span><span class="r14">) </span><span class="r17">*</span><span class="r14"> pixel_size))</span><span class="r16">         </span>  
 <span class="r10">  104 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  105 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  106 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">single_pixel_window</span><span class="r14">(x: </span><span class="r18">float</span><span class="r14">, y: </span><span class="r18">float</span><span class="r14">, ds: rio</span><span class="r17">.</span><span class="r14">io</span><span class="r17">.</span><span class="r14">D</span>  
 <span class="r10">  107 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  108 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Get a window representing a single pixel</span><span class="r16">            </span>  
 <span class="r10">  109 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  110 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    row_offset, col_offset </span><span class="r17">=</span><span class="r14"> ds</span><span class="r17">.</span><span class="r14">index(x, y)</span><span class="r16">             </span>  
 <span class="r10">  111 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> rio</span><span class="r17">.</span><span class="r14">windows</span><span class="r17">.</span><span class="r14">Window(col_offset, row_offset, </span><span class="r17">1</span><span class="r14">,</span>  
 <span class="r10">  112 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  113 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  114 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  115 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">tile_grid_affine</span><span class="r14">(region: </span><span class="r18">str</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> Affine:</span><span class="r16">            </span>  
 <span class="r10">  116 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  117 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Get the ARD tile grid affine based on the regional c</span>  
 <span class="r10">  118 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  119 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> {</span><span class="r16">                                            </span>  
 <span class="r10">  120 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;CU&#x27;</span><span class="r14">: (</span><span class="r17">-2565585</span><span class="r14">, </span><span class="r17">150000</span><span class="r14">, </span><span class="r17">0</span><span class="r14">, </span><span class="r17">3314805</span><span class="r14">, </span><span class="r17">0</span><span class="r14">, </span><span class="r17">-150000</span><span class="r14">)</span>  
 <span class="r10">  121 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    }[region]</span><span class="r16">                                           </span>  
 <span class="r10">  122 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  123 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  124 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">transform_geo</span><span class="r14">(x: </span><span class="r18">float</span><span class="r14">, y: </span><span class="r18">float</span><span class="r14">, affine: Affine) </span><span class="r17">-&gt;</span>  
 <span class="r10">  125 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  126 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Perform the affine transformation from an x/y coordi</span>  
 <span class="r10">  127 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  128 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    col </span><span class="r17">=</span><span class="r14"> (x </span><span class="r17">-</span><span class="r14"> affine[</span><span class="r17">0</span><span class="r14">] </span><span class="r17">-</span><span class="r14"> affine[</span><span class="r17">3</span><span class="r14">] </span><span class="r17">*</span><span class="r14"> affine[</span><span class="r17">2</span><span class="r14">]) </span><span class="r17">/</span><span class="r14"> affi</span>  
 <span class="r10">  129 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    row </span><span class="r17">=</span><span class="r14"> (y </span><span class="r17">-</span><span class="r14"> affine[</span><span class="r17">3</span><span class="r14">] </span><span class="r17">-</span><span class="r14"> affine[</span><span class="r17">0</span><span class="r14">] </span><span class="r17">*</span><span class="r14"> affine[</span><span class="r17">4</span><span class="r14">]) </span><span class="r17">/</span><span class="r14"> affi</span>  
 <span class="r10">  130 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> </span><span class="r18">int</span><span class="r14">(col), </span><span class="r18">int</span><span class="r14">(row)</span><span class="r16">                           </span>  
 <span class="r10">  131 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  132 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  133 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">determine_hv</span><span class="r14">(x: </span><span class="r18">float</span><span class="r14">, y: </span><span class="r18">float</span><span class="r14">, region: </span><span class="r18">str</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> Tup</span>  
 <span class="r10">  134 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  135 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Determine the ARD tile (in h/v coordinates) containi</span>  
 <span class="r10">  136 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  137 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    h, v </span><span class="r17">=</span><span class="r14"> transform_geo(x, y, tile_grid_affine(region))</span>  
 <span class="r10">  138 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> h, v</span><span class="r16">                                         </span>  
 <span class="r10">  139 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  140 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  141 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">determine_hvs</span><span class="r14">(bbox, region: </span><span class="r18">str</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> itertools</span><span class="r17">.</span><span class="r14">produc</span>  
 <span class="r10">  142 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  143 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Determine the h/v coordinates of tiles that intersec</span>  
 <span class="r10">  144 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  145 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    min_h, min_v </span><span class="r17">=</span><span class="r14"> determine_hv(bbox</span><span class="r17">.</span><span class="r14">min_x, bbox</span><span class="r17">.</span><span class="r14">max_y, </span>  
 <span class="r10">  146 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    max_h, max_v </span><span class="r17">=</span><span class="r14"> determine_hv(bbox</span><span class="r17">.</span><span class="r14">max_x, bbox</span><span class="r17">.</span><span class="r14">min_y, </span>  
 <span class="r10">  147 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> itertools</span><span class="r17">.</span><span class="r14">product(</span><span class="r18">range</span><span class="r14">(min_h, max_h </span><span class="r17">+</span><span class="r14"> </span><span class="r17">1</span><span class="r14">), </span><span class="r18">ra</span>  
 <span class="r10">  148 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  149 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  150 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">query_stac</span><span class="r14">(query_params: </span><span class="r18">dict</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> </span><span class="r18">dict</span><span class="r14">:</span><span class="r16">             </span>  
 <span class="r10">  151 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  152 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Query the STAC catalog using the provided query para</span>  
 <span class="r10">  153 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  154 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    stac </span><span class="r17">=</span><span class="r14"> pystac_client</span><span class="r17">.</span><span class="r14">Client</span><span class="r17">.</span><span class="r14">open(</span><span class="r24">&#x27;https://landsatloo</span>  
 <span class="r10">  155 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># This returns a dictionary with two keys, &#x27;type&#x27; an</span>  
 <span class="r10">  156 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    results </span><span class="r17">=</span><span class="r14"> stac</span><span class="r17">.</span><span class="r14">search(</span><span class="r17">**</span><span class="r14">query_params)</span><span class="r17">.</span><span class="r14">item_collectio</span>  
 <span class="r10">  157 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># &#x27;type&#x27; only contains the value &#x27;FeatureCollection&#x27;</span>  
 <span class="r10">  158 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> results[</span><span class="r24">&#x27;features&#x27;</span><span class="r14">]</span><span class="r16">                          </span>  
 <span class="r10">  159 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  160 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  161 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">group_dicts</span><span class="r14">(records: List[</span><span class="r18">dict</span><span class="r14">], key_func: Callable)</span>  
 <span class="r10">  162 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  163 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Group a list of dictionaries based on key value</span><span class="r16">     </span>  
 <span class="r10">  164 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  165 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    records </span><span class="r17">=</span><span class="r14"> </span><span class="r18">sorted</span><span class="r14">(records, key</span><span class="r17">=</span><span class="r14">key_func)</span><span class="r16">             </span>  
 <span class="r10">  166 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> itertools</span><span class="r17">.</span><span class="r14">groupby(records, key</span><span class="r17">=</span><span class="r14">key_func)</span><span class="r16">     </span>  
 <span class="r10">  167 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  168 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  169 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">convert_sr</span><span class="r14">(data: np</span><span class="r17">.</span><span class="r14">ndarray) </span><span class="r17">-&gt;</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">ndarray:</span><span class="r16">         </span>  
 <span class="r10">  170 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  171 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Re-scale Landsat Collection 2 spectral data values b</span>  
 <span class="r10">  172 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  173 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> ((data</span><span class="r17">.</span><span class="r14">astype(</span><span class="r18">float</span><span class="r14">) </span><span class="r17">*</span><span class="r14"> </span><span class="r17">0.0000275</span><span class="r14"> </span><span class="r17">-</span><span class="r14"> </span><span class="r17">0.2</span><span class="r14">) </span><span class="r17">*</span><span class="r14"> </span><span class="r17">100</span>  
 <span class="r10">  174 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  175 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  176 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">data_to_collection_1</span><span class="r14">(old_dict: </span><span class="r18">dict</span><span class="r14">, bands: List[</span><span class="r18">str</span>  
 <span class="r10">  177 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  178 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Convert a dictionary of surface reflectance bands to</span>  
 <span class="r10">  179 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  180 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    new_dict </span><span class="r17">=</span><span class="r14"> old_dict</span><span class="r17">.</span><span class="r14">copy()</span><span class="r16">                          </span>  
 <span class="r10">  181 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> key </span><span class="r23">in</span><span class="r14"> bands:</span><span class="r16">                                   </span>  
 <span class="r10">  182 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        new_dict[key] </span><span class="r17">=</span><span class="r14"> convert_sr(old_dict[key])</span><span class="r16">       </span>  
 <span class="r10">  183 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> new_dict</span><span class="r16">                                     </span>  
 <span class="r10">  184 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  185 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  186 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">read_bands</span><span class="r14">(record: </span><span class="r18">dict</span><span class="r14">, bands: List[</span><span class="r18">str</span><span class="r14">], plot: Tup</span>  
 <span class="r10">  187 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  188 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Read in an ROI for an observation in the STAC record</span>  
 <span class="r10">  189 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  190 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out </span><span class="r17">=</span><span class="r14"> {}</span><span class="r16">                                            </span>  
 <span class="r10">  191 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> band </span><span class="r23">in</span><span class="r14"> bands:</span><span class="r16">                                  </span>  
 <span class="r10">  192 </span>│<span class="r11">    5% </span>│<span class="r11">       </span>│<span class="r11">   5%  </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     4 </span>│<span class="r14">        </span><span class="r13">with</span><span class="r14"> rio</span><span class="r17">.</span><span class="r14">open(StacRecord</span><span class="r17">.</span><span class="r14">asset_href(record, band</span>  
 <span class="r10">  193 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            window </span><span class="r17">=</span><span class="r14"> centered_window(plot</span><span class="r17">.</span><span class="r14">x, plot</span><span class="r17">.</span><span class="r14">y, wid</span>  
 <span class="r10">  194 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r19"># Get a masked array and fill it to avoid a </span>  
 <span class="r10">  195 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">   5%  </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            out[band] </span><span class="r17">=</span><span class="r14"> ds</span><span class="r17">.</span><span class="r14">read(</span><span class="r17">1</span><span class="r14">, window</span><span class="r17">=</span><span class="r14">window, boundl</span>  
 <span class="r10">  196 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> out</span><span class="r16">                                          </span>  
 <span class="r10">  197 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  198 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  199 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">read_qa_at_plot</span><span class="r14">(record: </span><span class="r18">dict</span><span class="r14">, plot: Tuple[Any, </span><span class="r17">...</span><span class="r14">])</span>  
 <span class="r10">  200 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  201 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Read a single pixel at the plot location</span><span class="r16">            </span>  
 <span class="r10">  202 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  203 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">   1%  </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">with</span><span class="r14"> rio</span><span class="r17">.</span><span class="r14">open(StacRecord</span><span class="r17">.</span><span class="r14">asset_href(record, </span><span class="r24">&#x27;qa_pixe</span>  
 <span class="r10">  204 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        window </span><span class="r17">=</span><span class="r14"> single_pixel_window(plot</span><span class="r17">.</span><span class="r14">x, plot</span><span class="r17">.</span><span class="r14">y, ds)</span>  
 <span class="r10">  205 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out </span><span class="r17">=</span><span class="r14"> ds</span><span class="r17">.</span><span class="r14">read(</span><span class="r17">1</span><span class="r14">, window</span><span class="r17">=</span><span class="r14">window, boundless</span><span class="r17">=</span><span class="r13">False</span><span class="r14">)</span>  
 <span class="r10">  206 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> out</span><span class="r17">.</span><span class="r14">size </span><span class="r17">==</span><span class="r14"> </span><span class="r17">0</span><span class="r14">:</span><span class="r16">                                   </span>  
 <span class="r10">  207 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">1</span><span class="r14">  </span><span class="r19"># Treat values outside the spatial ext</span>  
 <span class="r10">  208 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> out</span><span class="r17">.</span><span class="r14">item()</span><span class="r16">                                   </span>  
 <span class="r10">  209 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  210 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  211 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">add_bands</span><span class="r14">(dict_a: </span><span class="r18">dict</span><span class="r14">, dict_b: </span><span class="r18">dict</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> </span><span class="r18">dict</span><span class="r14">:</span><span class="r16">      </span>  
 <span class="r10">  212 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  213 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Combine two observation dictionaries by adding the v</span>  
 <span class="r10">  214 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  215 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out </span><span class="r17">=</span><span class="r14"> {}</span><span class="r16">                                            </span>  
 <span class="r10">  216 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> band </span><span class="r23">in</span><span class="r14"> dict_a:</span><span class="r16">                                 </span>  
 <span class="r10">  217 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out[band] </span><span class="r17">=</span><span class="r14"> dict_a[band] </span><span class="r17">+</span><span class="r14"> dict_b[band]</span><span class="r16">         </span>  
 <span class="r10">  218 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> out</span><span class="r16">                                          </span>  
 <span class="r10">  219 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  220 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  221 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">composite</span><span class="r14">(data: </span><span class="r18">dict</span><span class="r14">, bands: List[</span><span class="r18">str</span><span class="r14">], axis: </span><span class="r18">int</span><span class="r14"> </span><span class="r17">=</span><span class="r14"> </span>  
 <span class="r10">  222 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  223 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Create a multi-band ndarray from band names</span><span class="r16">         </span>  
 <span class="r10">  224 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  225 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">stack([data[band] </span><span class="r13">for</span><span class="r14"> band </span><span class="r23">in</span><span class="r14"> bands], axis</span>  
 <span class="r10">  226 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  227 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  228 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">tasseled_cap</span><span class="r14">(data: </span><span class="r18">dict</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">ndarray:</span><span class="r16">             </span>  
 <span class="r10">  229 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  230 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Create a composite of tasseled cap values</span><span class="r16">           </span>  
 <span class="r10">  231 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  232 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    band_order </span><span class="r17">=</span><span class="r14"> [</span><span class="r24">&#x27;blue&#x27;</span><span class="r14">, </span><span class="r24">&#x27;green&#x27;</span><span class="r14">, </span><span class="r24">&#x27;red&#x27;</span><span class="r14">, </span><span class="r24">&#x27;nir08&#x27;</span><span class="r14">, </span><span class="r24">&#x27;swir</span>  
 <span class="r10">  233 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    arr </span><span class="r17">=</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">stack([data[band] </span><span class="r13">for</span><span class="r14"> band </span><span class="r23">in</span><span class="r14"> band_order], </span>  
 <span class="r10">  234 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">  80%   </span>│<span class="r1">   12M </span>│<span class="r1">▁              </span>│<span class="r12">       </span>│<span class="r14">    b </span><span class="r17">=</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">tensordot(arr, [</span><span class="r17">0.2043</span><span class="r14">, </span><span class="r17">0.4158</span><span class="r14">, </span><span class="r17">0.5524</span><span class="r14">, </span><span class="r17">0.574</span>  
 <span class="r10">  235 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    g </span><span class="r17">=</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">tensordot(arr, [</span><span class="r17">-0.1603</span><span class="r14">, </span><span class="r17">-0.2819</span><span class="r14">, </span><span class="r17">-0.4934</span><span class="r14">, </span><span class="r17">0.</span>  
 <span class="r10">  236 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    w </span><span class="r17">=</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">tensordot(arr, [</span><span class="r17">0.0315</span><span class="r14">, </span><span class="r17">0.2021</span><span class="r14">, </span><span class="r17">0.3102</span><span class="r14">, </span><span class="r17">0.159</span>  
 <span class="r10">  237 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">stack([b, g, w])</span><span class="r16">                          </span>  
 <span class="r10">  238 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  239 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  240 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">build_affine</span><span class="r14">(x_off: </span><span class="r18">float</span><span class="r14">, y_off: </span><span class="r18">float</span><span class="r14">, x_size: </span><span class="r18">flo</span>  
 <span class="r10">  241 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                 y_shear: </span><span class="r18">float</span><span class="r14"> </span><span class="r17">=</span><span class="r14"> </span><span class="r17">0</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> rio</span><span class="r17">.</span><span class="r14">Affine:</span><span class="r16">     </span>  
 <span class="r10">  242 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  243 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Build the affine tuple in the rasterio format (diffe</span>  
 <span class="r10">  244 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  245 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> rio</span><span class="r17">.</span><span class="r14">Affine(x_size, x_shear, x_off, y_shear, </span><span class="r17">-</span>  
 <span class="r10">  246 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  247 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  248 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">write_to_png</span><span class="r14">(file: </span><span class="r18">str</span><span class="r14">, array: np</span><span class="r17">.</span><span class="r14">ndarray, crs: </span><span class="r18">str</span><span class="r14">,</span>  
 <span class="r10">  249 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  250 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Write a PNG file as three 8-bit channels</span><span class="r16">            </span>  
 <span class="r10">  251 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  252 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    profile </span><span class="r17">=</span><span class="r14"> {</span><span class="r16">                                         </span>  
 <span class="r10">  253 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;driver&#x27;</span><span class="r14">: </span><span class="r24">&#x27;PNG&#x27;</span><span class="r14">,</span><span class="r16">                                </span>  
 <span class="r10">  254 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;count&#x27;</span><span class="r14">: </span><span class="r17">3</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">  255 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;nodata&#x27;</span><span class="r14">: </span><span class="r13">None</span><span class="r14">,</span><span class="r16">                                 </span>  
 <span class="r10">  256 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;crs&#x27;</span><span class="r14">: crs,</span><span class="r16">                                     </span>  
 <span class="r10">  257 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;transform&#x27;</span><span class="r14">: transform,</span><span class="r16">                         </span>  
 <span class="r10">  258 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;height&#x27;</span><span class="r14">: array</span><span class="r17">.</span><span class="r14">shape[</span><span class="r17">1</span><span class="r14">],</span><span class="r16">                       </span>  
 <span class="r10">  259 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;width&#x27;</span><span class="r14">: array</span><span class="r17">.</span><span class="r14">shape[</span><span class="r17">2</span><span class="r14">],</span><span class="r16">                        </span>  
 <span class="r10">  260 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;dtype&#x27;</span><span class="r14">: np</span><span class="r17">.</span><span class="r14">uint8}</span><span class="r16">                              </span>  
 <span class="r10">  261 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  262 </span>│<span class="r11">       </span>│<span class="r11">   14% </span>│<span class="r11">  54%  </span>│<span class="r1">   9%   </span>│<span class="r1">   54M </span>│<span class="r1">██▇▆▄▄▁▄▁  99% </span>│<span class="r12">     2 </span>│<span class="r14">    </span><span class="r13">with</span><span class="r14"> rio</span><span class="r17">.</span><span class="r14">open(file, mode</span><span class="r17">=</span><span class="r24">&#x27;w&#x27;</span><span class="r14">, </span><span class="r17">**</span><span class="r14">profile) </span><span class="r13">as</span><span class="r14"> ds:</span><span class="r16">     </span>  
 <span class="r10">  263 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ds</span><span class="r17">.</span><span class="r14">write(array)</span><span class="r16">                                 </span>  
 <span class="r10">  264 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  265 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  266 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">array_mask</span><span class="r14">(array: np</span><span class="r17">.</span><span class="r14">ndarray, value_to_mask </span><span class="r17">=</span><span class="r14"> </span><span class="r13">None</span><span class="r14">, </span>  
 <span class="r10">  267 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  268 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Boolean mask where the array matches the provided va</span>  
 <span class="r10">  269 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  270 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> (array </span><span class="r17">==</span><span class="r14"> value_to_mask)</span><span class="r17">.</span><span class="r14">any(axis</span><span class="r17">=</span><span class="r14">axis)</span><span class="r16">      </span>  
 <span class="r10">  271 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  272 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  273 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">apply_mask</span><span class="r14">(array: np</span><span class="r17">.</span><span class="r14">ndarray, mask_array: np</span><span class="r17">.</span><span class="r14">ndarray</span>  
 <span class="r10">  274 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  275 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Apply a Boolean mask </span><span class="r16">                               </span>  
 <span class="r10">  276 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  277 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    arr </span><span class="r17">=</span><span class="r14"> array</span><span class="r17">.</span><span class="r14">copy()</span><span class="r16">                                  </span>  
 <span class="r10">  278 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    arr[mask_array] </span><span class="r17">=</span><span class="r14"> mask_value</span><span class="r16">                        </span>  
 <span class="r10">  279 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> arr</span><span class="r16">                                          </span>  
 <span class="r10">  280 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  281 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  282 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">byte_scale</span><span class="r14">(array: np</span><span class="r17">.</span><span class="r14">ndarray, min_value: </span><span class="r18">float</span><span class="r14">, max_</span>  
 <span class="r10">  283 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  284 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Scale the data between min_value and max_value to 0-</span>  
 <span class="r10">  285 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  286 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out_array </span><span class="r17">=</span><span class="r14"> (</span><span class="r17">255</span><span class="r14"> </span><span class="r17">/</span><span class="r14"> (max_value </span><span class="r17">-</span><span class="r14"> min_value)) </span><span class="r17">*</span><span class="r14"> (array</span>  
 <span class="r10">  287 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out_array </span><span class="r17">=</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">minimum(out_array, </span><span class="r17">255</span><span class="r14">)</span><span class="r16">              </span>  
 <span class="r10">  288 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out_array </span><span class="r17">=</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">maximum(out_array, </span><span class="r17">0</span><span class="r14">)</span><span class="r16">                </span>  
 <span class="r10">  289 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> out_array</span><span class="r17">.</span><span class="r14">astype(np</span><span class="r17">.</span><span class="r14">uint8)</span><span class="r16">                   </span>  
 <span class="r10">  290 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  291 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  292 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">byte_scale_bands</span><span class="r14">(array: np</span><span class="r17">.</span><span class="r14">ndarray, all_bounds: List</span>  
 <span class="r10">  293 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                     mask: Optional[np</span><span class="r17">.</span><span class="r14">ndarray] </span><span class="r17">=</span><span class="r14"> </span><span class="r13">None</span><span class="r14">, </span>  
 <span class="r10">  294 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  295 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Convert a multi-band array to scaled 8-bit</span><span class="r16">          </span>  
 <span class="r10">  296 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Masked values are set to 0</span><span class="r16">                          </span>  
 <span class="r10">  297 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  298 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out </span><span class="r17">=</span><span class="r14"> []</span><span class="r16">                                            </span>  
 <span class="r10">  299 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> i, (min_value, max_value) </span><span class="r23">in</span><span class="r14"> </span><span class="r18">enumerate</span><span class="r14">(all_bound</span>  
 <span class="r10">  300 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r14">        byte_image </span><span class="r17">=</span><span class="r14"> byte_scale(array</span><span class="r17">.</span><span class="r14">take(i, axis</span><span class="r17">=</span><span class="r14">axis)</span>  
 <span class="r10">  301 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out</span><span class="r17">.</span><span class="r14">append(apply_mask(byte_image, mask, mask_val</span>  
 <span class="r10">  302 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> np</span><span class="r17">.</span><span class="r14">stack(out, axis</span><span class="r17">=</span><span class="r14">axis)</span><span class="r16">                     </span>  
 <span class="r10">  303 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  304 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  305 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">center</span><span class="r14">(array: np</span><span class="r17">.</span><span class="r14">ndarray) </span><span class="r17">-&gt;</span><span class="r14"> Tuple[</span><span class="r18">int</span><span class="r14">, </span><span class="r17">...</span><span class="r14">]:</span><span class="r16">       </span>  
 <span class="r10">  306 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  307 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Get the indices for the center of an array</span><span class="r16">          </span>  
 <span class="r10">  308 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  309 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> </span><span class="r18">tuple</span><span class="r14">(x </span><span class="r17">//</span><span class="r14"> </span><span class="r17">2</span><span class="r14"> </span><span class="r13">for</span><span class="r14"> x </span><span class="r23">in</span><span class="r14"> array</span><span class="r17">.</span><span class="r14">shape)</span><span class="r16">           </span>  
 <span class="r10">  310 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  311 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  312 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">center_value</span><span class="r14">(array: np</span><span class="r17">.</span><span class="r14">ndarray) </span><span class="r17">-&gt;</span><span class="r14"> </span><span class="r18">int</span><span class="r14">:</span><span class="r16">             </span>  
 <span class="r10">  313 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  314 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Get the center value of an array</span><span class="r16">                    </span>  
 <span class="r10">  315 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  316 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> array[center(array)]</span><span class="r16">                         </span>  
 <span class="r10">  317 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  318 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  319 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">spectral_data</span><span class="r14">(data: </span><span class="r18">dict</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> </span><span class="r18">dict</span><span class="r14">:</span><span class="r16">                  </span>  
 <span class="r10">  320 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  321 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Get the data for the center pixel in the chip</span><span class="r16">       </span>  
 <span class="r10">  322 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  323 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> {band: center_value(array) </span><span class="r13">for</span><span class="r14"> band, array </span><span class="r23">in</span>  
 <span class="r10">  324 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  325 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  326 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">df_to_csv</span><span class="r14">(df: pd</span><span class="r17">.</span><span class="r14">DataFrame, params: </span><span class="r18">dict</span><span class="r14">, output: </span><span class="r18">di</span>  
 <span class="r10">  327 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  328 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Write the dataframe to the csv file</span><span class="r16">                 </span>  
 <span class="r10">  329 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  330 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    fs </span><span class="r17">=</span><span class="r14"> fsspec</span><span class="r17">.</span><span class="r14">filesystem(</span><span class="r24">&#x27;s3&#x27;</span><span class="r14">, anon</span><span class="r17">=</span><span class="r13">False</span><span class="r14">, requester_p</span>  
 <span class="r10">  331 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  332 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">   3%  </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r14">    </span><span class="r13">with</span><span class="r14"> fs</span><span class="r17">.</span><span class="r14">open(output[</span><span class="r24">&#x27;scsv&#x27;</span><span class="r14">], </span><span class="r24">&#x27;w&#x27;</span><span class="r14">) </span><span class="r13">as</span><span class="r14"> f:</span><span class="r16">             </span>  
 <span class="r10">  333 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        df</span><span class="r17">.</span><span class="r14">to_csv(f, index</span><span class="r17">=</span><span class="r13">False</span><span class="r14">)</span><span class="r16">                       </span>  
 <span class="r10">  334 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  335 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  336 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">check_bit</span><span class="r14">(value: </span><span class="r18">int</span><span class="r14">, bit: </span><span class="r18">int</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> </span><span class="r18">bool</span><span class="r14">:</span><span class="r16">            </span>  
 <span class="r10">  337 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  338 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Check whether a bit is set</span><span class="r16">                          </span>  
 <span class="r10">  339 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  340 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> </span><span class="r18">bool</span><span class="r14">((value </span><span class="r17">&amp;</span><span class="r14"> (</span><span class="r17">1</span><span class="r14"> </span><span class="r17">&lt;&lt;</span><span class="r14"> bit)))</span><span class="r16">                   </span>  
 <span class="r10">  341 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  342 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  343 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">passes_qa_check</span><span class="r14">(qa: </span><span class="r18">int</span><span class="r14">, enable_cloud_filtering</span><span class="r17">=</span><span class="r13">Fals</span>  
 <span class="r10">  344 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  345 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Make sure the QA value is not indicating fill and (o</span>  
 <span class="r10">  346 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  347 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> check_bit(qa, QA_FILL):</span><span class="r16">                          </span>  
 <span class="r10">  348 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                                    </span>  
 <span class="r10">  349 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> enable_cloud_filtering </span><span class="r23">and</span><span class="r14"> </span><span class="r23">not</span><span class="r14"> (check_bit(qa, QA_</span>  
 <span class="r10">  350 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r13">False</span><span class="r16">                                    </span>  
 <span class="r10">  351 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> </span><span class="r13">True</span><span class="r16">                                         </span>  
 <span class="r10">  352 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  353 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">classify_qa</span><span class="r14">(qa: </span><span class="r18">int</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> </span><span class="r18">int</span><span class="r14">:</span><span class="r16">                        </span>  
 <span class="r10">  354 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  355 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Return a value indicating the pixel is clear/water (</span>  
 <span class="r10">  356 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  357 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> passes_qa_check(qa, enable_cloud_filtering</span><span class="r17">=</span><span class="r13">True</span><span class="r14">):</span>  
 <span class="r10">  358 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r14"> </span><span class="r17">0</span><span class="r16">                                        </span>  
 <span class="r10">  359 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> </span><span class="r17">1</span><span class="r16">                                            </span>  
 <span class="r10">  360 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  361 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  362 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">build_df</span><span class="r14">(pixel_data: </span><span class="r18">dict</span><span class="r14">, record: </span><span class="r18">dict</span><span class="r14">, project_id:</span>  
 <span class="r10">  363 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  364 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Build the output dataframe</span><span class="r16">                          </span>  
 <span class="r10">  365 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  366 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> pd</span><span class="r17">.</span><span class="r14">DataFrame({</span><span class="r16">                               </span>  
 <span class="r10">  367 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;sensor&#x27;</span><span class="r14">: StacRecord</span><span class="r17">.</span><span class="r14">sensor(record),</span><span class="r16">            </span>  
 <span class="r10">  368 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;project_id&#x27;</span><span class="r14">: project_id,</span><span class="r16">                       </span>  
 <span class="r10">  369 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;plot_id&#x27;</span><span class="r14">: plot_id,</span><span class="r16">                             </span>  
 <span class="r10">  370 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;hv&#x27;</span><span class="r14">: StacRecord</span><span class="r17">.</span><span class="r14">hv(record),</span><span class="r16">                    </span>  
 <span class="r10">  371 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;year&#x27;</span><span class="r14">: StacRecord</span><span class="r17">.</span><span class="r14">year(record),</span><span class="r16">                </span>  
 <span class="r10">  372 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;doy&#x27;</span><span class="r14">: StacRecord</span><span class="r17">.</span><span class="r14">doy(record),</span><span class="r16">                  </span>  
 <span class="r10">  373 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;blue&#x27;</span><span class="r14">: pixel_data[</span><span class="r24">&#x27;blue&#x27;</span><span class="r14">],</span><span class="r16">                     </span>  
 <span class="r10">  374 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;green&#x27;</span><span class="r14">: pixel_data[</span><span class="r24">&#x27;green&#x27;</span><span class="r14">],</span><span class="r16">                   </span>  
 <span class="r10">  375 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;red&#x27;</span><span class="r14">: pixel_data[</span><span class="r24">&#x27;red&#x27;</span><span class="r14">],</span><span class="r16">                       </span>  
 <span class="r10">  376 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;nir&#x27;</span><span class="r14">: pixel_data[</span><span class="r24">&#x27;nir08&#x27;</span><span class="r14">],</span><span class="r16">                     </span>  
 <span class="r10">  377 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;swir1&#x27;</span><span class="r14">: pixel_data[</span><span class="r24">&#x27;swir16&#x27;</span><span class="r14">],</span><span class="r16">                  </span>  
 <span class="r10">  378 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;swir2&#x27;</span><span class="r14">: pixel_data[</span><span class="r24">&#x27;swir22&#x27;</span><span class="r14">],</span><span class="r16">                  </span>  
 <span class="r10">  379 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;qa&#x27;</span><span class="r14">: classify_qa(pixel_data[</span><span class="r24">&#x27;qa_pixel&#x27;</span><span class="r14">]),</span><span class="r16">      </span>  
 <span class="r10">  380 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;date&#x27;</span><span class="r14">: StacRecord</span><span class="r17">.</span><span class="r14">date(record)}, index</span><span class="r17">=</span><span class="r14">[</span><span class="r17">0</span><span class="r14">])</span><span class="r16">    </span>  
 <span class="r10">  381 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  382 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  383 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">invalid_pixel</span><span class="r14">() </span><span class="r17">-&gt;</span><span class="r14"> </span><span class="r18">dict</span><span class="r14">:</span><span class="r16">                            </span>  
 <span class="r10">  384 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  385 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Get band values to represent and invalid pixel</span><span class="r16">      </span>  
 <span class="r10">  386 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  387 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> {</span><span class="r16">                                            </span>  
 <span class="r10">  388 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;blue&#x27;</span><span class="r14">: </span><span class="r17">0</span><span class="r14">,</span><span class="r16">                                      </span>  
 <span class="r10">  389 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;green&#x27;</span><span class="r14">: </span><span class="r17">0</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">  390 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;red&#x27;</span><span class="r14">: </span><span class="r17">0</span><span class="r14">,</span><span class="r16">                                       </span>  
 <span class="r10">  391 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;nir08&#x27;</span><span class="r14">: </span><span class="r17">0</span><span class="r14">,</span><span class="r16">                                     </span>  
 <span class="r10">  392 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;swir16&#x27;</span><span class="r14">: </span><span class="r17">0</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  393 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;swir22&#x27;</span><span class="r14">: </span><span class="r17">0</span><span class="r14">,</span><span class="r16">                                    </span>  
 <span class="r10">  394 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;qa_pixel&#x27;</span><span class="r14">: </span><span class="r17">1</span><span class="r14">}</span><span class="r16">                                  </span>  
 <span class="r10">  395 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  396 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">build_query</span><span class="r14">(h: </span><span class="r18">int</span><span class="r14">, v: </span><span class="r18">int</span><span class="r14">, region: </span><span class="r18">str</span><span class="r14"> </span><span class="r17">=</span><span class="r14"> </span><span class="r24">&#x27;CU&#x27;</span><span class="r14">, coll</span>  
 <span class="r10">  397 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                datetime: </span><span class="r18">str</span><span class="r14"> </span><span class="r17">=</span><span class="r14"> </span><span class="r24">&#x27;1984-01/1985-12-31&#x27;</span><span class="r14">, li</span>  
 <span class="r10">  398 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  399 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Construct a STAC query based on h/v tile coordinates</span>  
 <span class="r10">  400 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  401 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> {</span><span class="r16">                                            </span>  
 <span class="r10">  402 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;collections&#x27;</span><span class="r14">: collection,</span><span class="r16">                      </span>  
 <span class="r10">  403 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;datetime&#x27;</span><span class="r14">: datetime,</span><span class="r16">                           </span>  
 <span class="r10">  404 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;limit&#x27;</span><span class="r14">: limit,</span><span class="r16">                                 </span>  
 <span class="r10">  405 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;query&#x27;</span><span class="r14">: {</span><span class="r24">&#x27;landsat:grid_horizontal&#x27;</span><span class="r14">: {</span><span class="r24">&#x27;eq&#x27;</span><span class="r14">: </span><span class="r24">f&#x27;</span><span class="r25">{</span><span class="r14">h</span>  
 <span class="r10">  406 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                  </span><span class="r24">&#x27;landsat:grid_vertical&#x27;</span><span class="r14">: {</span><span class="r24">&#x27;eq&#x27;</span><span class="r14">: </span><span class="r24">f&#x27;</span><span class="r25">{</span><span class="r14">v</span><span class="r25">:</span><span class="r24">0</span>  
 <span class="r10">  407 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                  </span><span class="r24">&#x27;landsat:grid_region&#x27;</span><span class="r14">: {</span><span class="r24">&#x27;eq&#x27;</span><span class="r14">: region}}</span>  
 <span class="r10">  408 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  409 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">group_records</span><span class="r14">(records: List[</span><span class="r18">dict</span><span class="r14">]) </span><span class="r17">-&gt;</span><span class="r14"> List[List[</span><span class="r18">dict</span>  
 <span class="r10">  410 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  411 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Group records based on the observation ID</span><span class="r16">           </span>  
 <span class="r10">  412 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  413 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    out </span><span class="r17">=</span><span class="r14"> []</span><span class="r16">                                            </span>  
 <span class="r10">  414 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> _, group </span><span class="r23">in</span><span class="r14"> group_dicts(records, StacRecord</span><span class="r17">.</span><span class="r14">year</span>  
 <span class="r10">  415 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        out</span><span class="r17">.</span><span class="r14">append(</span><span class="r18">list</span><span class="r14">(group))</span><span class="r16">                         </span>  
 <span class="r10">  416 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> out</span><span class="r16">                                          </span>  
 <span class="r10">  417 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  418 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">stac_records_for_plot</span><span class="r14">(plot: Tuple[Any, </span><span class="r17">...</span><span class="r14">], params:</span>  
 <span class="r10">  419 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  420 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Retrieve the stac records relevant for the plot</span><span class="r16">     </span>  
 <span class="r10">  421 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  422 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    query_results </span><span class="r17">=</span><span class="r14"> []</span><span class="r16">                                  </span>  
 <span class="r10">  423 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    roi </span><span class="r17">=</span><span class="r14"> centered_bounds(plot</span><span class="r17">.</span><span class="r14">x, plot</span><span class="r17">.</span><span class="r14">y, params[</span><span class="r24">&#x27;chip_s</span>  
 <span class="r10">  424 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    my_year </span><span class="r17">=</span><span class="r14"> params[</span><span class="r24">&#x27;year&#x27;</span><span class="r14">]</span><span class="r16">                            </span>  
 <span class="r10">  425 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    my_dates </span><span class="r17">=</span><span class="r14"> </span><span class="r24">f&#x27;</span><span class="r25">{</span><span class="r14">my_year</span><span class="r25">}</span><span class="r24">-01-01/</span><span class="r25">{</span><span class="r14">my_year</span><span class="r25">}</span><span class="r24">-12-01&#x27;</span><span class="r16">       </span>  
 <span class="r10">  426 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> h, v </span><span class="r23">in</span><span class="r14"> determine_hvs(roi, region</span><span class="r17">=</span><span class="r14">params[</span><span class="r24">&#x27;region</span>  
 <span class="r10">  427 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        query_results</span><span class="r17">.</span><span class="r14">extend(query_stac(build_query(h, v</span>  
 <span class="r10">  428 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">return</span><span class="r14"> query_results</span><span class="r16">                                </span>  
 <span class="r10">  429 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  430 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">make_dirs</span><span class="r14">(fs, file: </span><span class="r18">str</span><span class="r14">) </span><span class="r17">-&gt;</span><span class="r14"> </span><span class="r13">None</span><span class="r14">:</span><span class="r16">                   </span>  
 <span class="r10">  431 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  432 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Create parent directories if it makes sense to do so</span>  
 <span class="r10">  433 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  434 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r18">isinstance</span><span class="r14">(fs, LocalFileSystem):</span><span class="r16">                 </span>  
 <span class="r10">  435 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        fs</span><span class="r17">.</span><span class="r14">makedirs(os</span><span class="r17">.</span><span class="r14">path</span><span class="r17">.</span><span class="r14">dirname(file), exist_ok</span><span class="r17">=</span><span class="r13">True</span>  
 <span class="r10">  436 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  437 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  438 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">process_group</span><span class="r14">(group: List[</span><span class="r18">dict</span><span class="r14">], plot: Tuple[Any, </span><span class="r17">..</span>  
 <span class="r10">  439 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  440 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Process a group of STAC records associated with a pl</span>  
 <span class="r10">  441 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">  442 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    fs </span><span class="r17">=</span><span class="r14"> fsspec</span><span class="r17">.</span><span class="r14">filesystem(</span><span class="r24">&#x27;s3&#x27;</span><span class="r14">, anon</span><span class="r17">=</span><span class="r13">False</span><span class="r14">, requester_p</span>  
 <span class="r10">  443 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  444 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># Set up the output filenames and (as applicable) di</span>  
 <span class="r10">  445 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output </span><span class="r17">=</span><span class="r14"> adjust_for_s3(</span><span class="r16">                             </span>  
 <span class="r10">  446 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        output_files(params[</span><span class="r24">&#x27;project_dir&#x27;</span><span class="r14">], plot</span><span class="r17">.</span><span class="r14">project</span>  
 <span class="r10">  447 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        fs)</span><span class="r16">                                             </span>  
 <span class="r10">  448 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> out </span><span class="r23">in</span><span class="r14"> output</span><span class="r17">.</span><span class="r14">values():</span><span class="r16">                         </span>  
 <span class="r10">  449 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        make_dirs(fs, out)</span><span class="r16">                              </span>  
 <span class="r10">  450 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  451 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># Determine if the center pixel is fill</span><span class="r16">             </span>  
 <span class="r10">  452 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">if</span><span class="r14"> </span><span class="r23">not</span><span class="r14"> </span><span class="r18">any</span><span class="r14">(passes_qa_check(read_qa_at_plot(record, p</span>  
 <span class="r10">  453 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r19"># Optionally, write an entry for an invalid pixe</span>  
 <span class="r10">  454 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r19"># but because TimeSync does not expect this entr</span>  
 <span class="r10">  455 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r19"># df_to_csv(build_df(invalid_pixel(), group[0], </span>  
 <span class="r10">  456 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">return</span><span class="r16">                                          </span>  
 <span class="r10">  457 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  458 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># Read and combine the data records</span><span class="r16">                 </span>  
 <span class="r10">  459 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    data_stack </span><span class="r17">=</span><span class="r14"> [</span><span class="r16">                                      </span>  
 <span class="r10">  460 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        read_bands(observation, timesync_band_list(), pl</span>  
 <span class="r10">  461 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        observation </span><span class="r23">in</span><span class="r14"> group]</span><span class="r16">                           </span>  
 <span class="r10">  462 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    combined_data </span><span class="r17">=</span><span class="r14"> data_to_collection_1(reduce(add_band</span>  
 <span class="r10">  463 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  464 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  465 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># Get geospatial attributes</span><span class="r16">                         </span>  
 <span class="r10">  466 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    bounds </span><span class="r17">=</span><span class="r14"> centered_bounds(plot</span><span class="r17">.</span><span class="r14">x, plot</span><span class="r17">.</span><span class="r14">y, params[</span><span class="r24">&#x27;chi</span>  
 <span class="r10">  467 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    aff </span><span class="r17">=</span><span class="r14"> build_affine(bounds</span><span class="r17">.</span><span class="r14">min_x, bounds</span><span class="r17">.</span><span class="r14">max_y)</span><span class="r16">      </span>  
 <span class="r10">  468 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    crs </span><span class="r17">=</span><span class="r14"> StacRecord</span><span class="r17">.</span><span class="r14">crs(group[</span><span class="r17">0</span><span class="r14">])</span><span class="r16">                      </span>  
 <span class="r10">  469 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  470 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># Mask for fill values</span><span class="r16">                              </span>  
 <span class="r10">  471 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    fill_value </span><span class="r17">=</span><span class="r14"> convert_sr(np</span><span class="r17">.</span><span class="r14">array(LANDSAT_ARD_C2_FILL</span>  
 <span class="r10">  472 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    mask </span><span class="r17">=</span><span class="r14"> array_mask(composite(combined_data, landsat_o</span>  
 <span class="r10">  473 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  474 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># Calculate the output chip data</span><span class="r16">                    </span>  
 <span class="r10">  475 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output_tcap </span><span class="r17">=</span><span class="r14"> tasseled_cap(combined_data)</span><span class="r16">           </span>  
 <span class="r10">  476 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output_b743 </span><span class="r17">=</span><span class="r14"> composite(combined_data, bands</span><span class="r17">=</span><span class="r14">[</span><span class="r24">&#x27;swir2</span>  
 <span class="r10">  477 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    output_b432 </span><span class="r17">=</span><span class="r14"> composite(combined_data, bands</span><span class="r17">=</span><span class="r14">[</span><span class="r24">&#x27;nir08</span>  
 <span class="r10">  478 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  479 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># Stretch the chip data and write to PNG</span><span class="r16">            </span>  
 <span class="r10">  480 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    write_to_png(output[</span><span class="r24">&#x27;tcap&#x27;</span><span class="r14">], byte_scale_bands(output</span>  
 <span class="r10">  481 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    write_to_png(output[</span><span class="r24">&#x27;b743&#x27;</span><span class="r14">], byte_scale_bands(output</span>  
 <span class="r10">  482 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    write_to_png(output[</span><span class="r24">&#x27;b432&#x27;</span><span class="r14">], byte_scale_bands(output</span>  
 <span class="r10">  483 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  484 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># Define the metadata and spectral data for this obs</span>  
 <span class="r10">  485 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    df_to_csv(build_df(spectral_data(combined_data), gro</span>  
 <span class="r10">  486 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">  487 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">      </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│                                                          
╶──────┼───────┼───────┼───────┼────────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────╴
 <span class="r10">      </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r27">function summary for /home/ec2-user/opt/timesync/tony/2…</span>  
 <span class="r10">  150 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">   1%  </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">query_stac</span><span class="r16">                                              </span>  
 <span class="r10">  186 </span>│<span class="r11">    6% </span>│<span class="r11">       </span>│<span class="r11">  10%  </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     4 </span>│<span class="r14">read_bands</span><span class="r16">                                              </span>  
 <span class="r10">  199 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">   2%  </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">read_qa_at_plot</span><span class="r16">                                         </span>  
 <span class="r10">  228 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">  80%   </span>│<span class="r1">   12M </span>│<span class="r1">▂              </span>│<span class="r12">       </span>│<span class="r14">tasseled_cap</span><span class="r16">                                            </span>  
 <span class="r10">  248 </span>│<span class="r11">       </span>│<span class="r11">   14% </span>│<span class="r11">  54%  </span>│<span class="r1">   9%   </span>│<span class="r1">   54M </span>│<span class="r1">███████▁▁  99% </span>│<span class="r12">     2 </span>│<span class="r14">write_to_png</span><span class="r16">                                            </span>  
 <span class="r10">  282 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">byte_scale</span><span class="r16">                                              </span>  
 <span class="r10">  326 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">   3%  </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     1 </span>│<span class="r14">df_to_csv</span><span class="r16">                                               </span>  
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                          
Top AVERAGE memory consumption, by line:
<span class="r1">(1)   262:    54 MB</span>                                                                                                                 
Top PEAK memory consumption, by line:
<span class="r1">(1)   262:    54 MB</span>                                                                                                                 
<span class="r1">(2)   234:    12 MB</span>                                                                                                                 
<span class="r1">(3)    10:    10 MB</span>                                                                                                                 
<span class="r1">(4)     8:    10 MB</span>                                                                                                                 
<span class="r1">(5)     6:    10 MB</span>                                                                                                                 
<span class="r28">            /home/ec2-user/opt/timesync/tony/2a_cmdline/ts_main_loop.py: % of time =   3.74% (6.908s) out of 3m:4.534s.            </span>
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                          
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r4">Memory</span><span class="r2">  </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r4">–––––––––––</span><span class="r2">    </span>│<span class="r5">Copy</span><span class="r2">   </span>│<span class="r2">                                                         </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">system</span><span class="r2"> </span>│<span class="r8">Python</span><span class="r2">  </span>│<span class="r8">peak</span><span class="r2">   </span>│<span class="r8">timeline</span><span class="r4">/%</span><span class="r2">     </span>│<span class="r9">(MB/s)</span><span class="r2"> </span>│<span class="r2">/home/ec2-user/opt/timesync/tony/2a_cmdline/ts_main_loo… </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r19">#!/usr/bin/env python</span><span class="r16">                                   </span>  
 <span class="r10">    2 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r19"># coding: utf-8</span><span class="r16">                                         </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r19"># Python AWS and GDAL BS</span><span class="r16">                                </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">os</span><span class="r16">                                               </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">os</span><span class="r17">.</span><span class="r14">environ[</span><span class="r24">&#x27;AWS_REQUEST_PAYER&#x27;</span><span class="r14">] </span><span class="r17">=</span><span class="r14"> </span><span class="r24">&#x27;requester&#x27;</span><span class="r16">           </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">os</span><span class="r17">.</span><span class="r14">environ[</span><span class="r24">&#x27;GDAL_DISABLE_READDIR_ON_OPEN&#x27;</span><span class="r14">]</span><span class="r17">=</span><span class="r24">&#x27;EMPTY_DIR&#x27;</span><span class="r16">  </span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">os</span><span class="r17">.</span><span class="r14">environ[</span><span class="r24">&#x27;GDAL_HTTP_MAX_RETRY&#x27;</span><span class="r14">]</span><span class="r17">=</span><span class="r24">&#x27;10&#x27;</span><span class="r16">                  </span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">os</span><span class="r17">.</span><span class="r14">environ[</span><span class="r24">&#x27;GDAL_HTTP_RETRY_DELAY&#x27;</span><span class="r14">]</span><span class="r17">=</span><span class="r24">&#x27;3&#x27;</span><span class="r16">                 </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">os</span><span class="r17">.</span><span class="r14">environ[</span><span class="r24">&#x27;GDAL_PAM_ENABLED&#x27;</span><span class="r14">]</span><span class="r17">=</span><span class="r24">&#x27;NO&#x27;</span><span class="r16">                     </span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">functools</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> partial, reduce, wraps</span><span class="r16">            </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">typing</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> List, Tuple, Optional, Any, Callable,</span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">   2%  </span>│<span class="r1"> 100%   </span>│<span class="r1">   30M </span>│<span class="r1">▁▁▁            </span>│<span class="r12">     3 </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">pandas</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">pd</span><span class="r16">                                     </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">ts_process_group</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> stac_records_for_plot, grou</span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">ts_process_group</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> process_group</span><span class="r16">              </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">ts_log_stuff</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> format_plot_data, log_file_name</span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">process_plot</span><span class="r14">(plot: Tuple[Any, </span><span class="r17">...</span><span class="r14">], params: </span><span class="r18">dict</span><span class="r14">) </span><span class="r17">-&gt;</span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Process an individual plot</span><span class="r16">                          </span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r18">print</span><span class="r14">(</span><span class="r24">&#x27;called process_plot&#x27;</span><span class="r14">)</span><span class="r16">                        </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    groups </span><span class="r17">=</span><span class="r14"> group_records(stac_records_for_plot(plot, p</span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> group </span><span class="r23">in</span><span class="r14"> groups:</span><span class="r16">                                </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        process_group(group, plot, params)</span><span class="r16">              </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">process_on_local</span><span class="r14">(project_dir, project_id, plot_id, r</span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Local single-threaded processing</span><span class="r16">                    </span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r16">                                                </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    plot_file</span><span class="r17">=</span><span class="r24">f&#x27;fake_plot_file_</span><span class="r25">{</span><span class="r14">project_id</span><span class="r25">}</span><span class="r24">_plot</span><span class="r25">{</span><span class="r14">plot_id</span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    params </span><span class="r17">=</span><span class="r14"> {</span><span class="r16">                                          </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;project_dir&#x27;</span><span class="r14">: project_dir, </span><span class="r16">                    </span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;plot_file&#x27;</span><span class="r14">: plot_file, </span><span class="r16">                        </span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;region&#x27;</span><span class="r14">: region, </span><span class="r16">                              </span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;chip_size&#x27;</span><span class="r14">: chip_size,</span><span class="r16">                         </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;year&#x27;</span><span class="r14">: year</span><span class="r16">                                    </span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    }</span><span class="r16">                                                   </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r19"># make plot df for legacy expectations Kelcy and Cod</span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r16">                                                    </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    plot_l </span><span class="r17">=</span><span class="r14"> []</span><span class="r16">                                         </span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    plot_d </span><span class="r17">=</span><span class="r14"> {</span><span class="r16">                                          </span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r24">&#x27;project_id&#x27;</span><span class="r14">: project_id,</span><span class="r16">                   </span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r24">&#x27;plot_id&#x27;</span><span class="r14">: plot_id,</span><span class="r16">                         </span>  
 <span class="r10">   54 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r24">&#x27;x&#x27;</span><span class="r14">: x,</span><span class="r16">                                     </span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r24">&#x27;y&#x27;</span><span class="r14">:y</span><span class="r16">                                       </span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            }</span><span class="r16">                                           </span>  
 <span class="r10">   57 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    plot_l</span><span class="r17">.</span><span class="r14">append(plot_d)</span><span class="r16">                               </span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   59 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    plots_df </span><span class="r17">=</span><span class="r14"> pd</span><span class="r17">.</span><span class="r14">DataFrame(plot_l)  </span><span class="r19"># plots is misnomer</span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> plot </span><span class="r23">in</span><span class="r14"> plots_df</span><span class="r17">.</span><span class="r14">itertuples():</span><span class="r16">                  </span>  
 <span class="r10">   61 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r18">print</span><span class="r14">(plot)</span><span class="r16">                                     </span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        process_plot(plot, params)</span><span class="r16">                      </span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r18">print</span><span class="r14">(</span><span class="r24">&#x27;Success tracking goes here&#x27;</span><span class="r14">)</span><span class="r16">             </span>  
 <span class="r10">   64 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">  </span><span class="r16">                                                      </span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   66 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">timesync_data_extraction</span><span class="r14">(project_dir, project_id, pl</span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r21">    </span><span class="r22">&quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    Run TimeSync data extraction</span><span class="r16">                        </span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r22">    &quot;&quot;&quot;</span><span class="r16">                                                 </span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    process_on_local(project_dir, project_id, plot_id, r</span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">def</span><span class="r14"> </span><span class="r20">run_timesync</span><span class="r14">(plot_id, year, x, y, project_id):</span><span class="r16">      </span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    config_params </span><span class="r17">=</span><span class="r14"> {</span><span class="r16">                                   </span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;project_dir&#x27;</span><span class="r14">: </span><span class="r24">f&#x27;s3://dev-nlcd-developer/timesyn</span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;project_id&#x27;</span><span class="r14">: project_id,</span><span class="r16">                       </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;plot_id&#x27;</span><span class="r14">: plot_id,</span><span class="r16">                             </span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;region&#x27;</span><span class="r14">: </span><span class="r24">&#x27;CU&#x27;</span><span class="r14">, </span><span class="r16">                                </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;chip_size&#x27;</span><span class="r14">: [</span><span class="r17">255</span><span class="r14">, </span><span class="r17">255</span><span class="r14">],</span><span class="r16">                        </span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;year&#x27;</span><span class="r14">: year,</span><span class="r16">                                   </span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;x&#x27;</span><span class="r14">: x,</span><span class="r16">                                         </span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r24">&#x27;y&#x27;</span><span class="r14">: y</span><span class="r16">                                          </span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    }</span><span class="r16">                                                   </span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    timesync_data_extraction(</span><span class="r17">**</span><span class="r14">config_params)  </span><span class="r19"># docker </span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r1">        </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                        </span>  
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                          
Top PEAK memory consumption, by line:
<span class="r1">(1)    17:    30 MB</span>                                                                                                                 
generated by the <a class="r29" href="https://github.com/plasma-umass/scalene">scalene</a> profiler                                                                                                   
</code></pre>
</body>
</html>
